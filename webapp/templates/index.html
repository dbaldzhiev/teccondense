<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Condensation Risk Calculator</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}" />
    <style>
      /* Small inline fallback if static not served */
      body{font-family:system-ui,Segoe UI,Roboto,Arial,sans-serif;margin:0;background:#0f172a;color:#e5e7eb}
      .container{max-width:1100px;margin:0 auto;padding:24px}
      h1{margin:0 0 12px;font-size:28px}
      .grid{display:grid;grid-template-columns:1fr 1fr;gap:16px}
      .card{background:#111827;border:1px solid #374151;border-radius:10px;padding:16px}
      label{display:block;font-size:12px;color:#9ca3af;margin:6px 0 4px}
      input,select{width:100%;padding:8px;border-radius:8px;border:1px solid #374151;background:#0b1220;color:#e5e7eb}
      .row{display:grid;grid-template-columns:1.5fr repeat(6,1fr);gap:8px;align-items:end}
      .btn{background:#2563eb;border:none;color:#fff;padding:8px 12px;border-radius:8px;cursor:pointer}
      .btn.secondary{background:#374151}
      .btn.danger{background:#dc2626}
      .actions{display:flex;gap:8px;flex-wrap:wrap}
      .charts{display:grid;grid-template-columns:1fr 1fr;gap:16px}
      canvas{width:100%;height:300px;background:#0b1220;border:1px solid #374151;border-radius:8px}
      .result{font-family:ui-monospace, SFMono-Regular, Menlo, monospace;white-space:pre-wrap}
      .footer{opacity:.7;margin-top:12px;font-size:12px}
    </style>
    <script defer src="{{ url_for('static', filename='app.js') }}"></script>
</head>
<body>
  <div class="container">
    <h1>Condensation Risk Calculator</h1>
    <div class="grid">
      <div class="card">
        <h3>Layers (inside → outside)</h3>
        <div id="layers"></div>
        <div class="actions" style="margin-top:8px">
          <button class="btn" onclick="addLayer()">Add Layer</button>
          <button class="btn danger" onclick="removeLayer()">Remove Last</button>
          <button class="btn secondary" onclick="loadMaterials()">Load Materials</button>
        </div>
      </div>
      <div class="card">
        <h3>Climate & Surface Resistances</h3>
        <div class="row">
          <div>
            <label>θi (°C)</label>
            <input type="number" step="0.1" id="theta_i" value="20">
          </div>
          <div>
            <label>φi (%)</label>
            <input type="number" step="0.1" id="phi_i" value="65">
          </div>
          <div>
            <label>θe (°C)</label>
            <input type="number" step="0.1" id="theta_e" value="5">
          </div>
          <div>
            <label>φe (%)</label>
            <input type="number" step="0.1" id="phi_e" value="90">
          </div>
          <div>
            <label>Rsi (m²·K/W)</label>
            <input type="number" step="0.01" id="Rsi" value="0.13">
          </div>
          <div>
            <label>Rse (m²·K/W)</label>
            <input type="number" step="0.01" id="Rse" value="0.04">
          </div>
        </div>
        <div class="row">
          <div>
            <label>tk (h)</label>
            <input type="number" step="1" id="tk" value="1440">
          </div>
          <div>
            <label>tu (h)</label>
            <input type="number" step="1" id="tu" value="1440">
          </div>
          <div>
            <label>Climate Preset</label>
            <select id="climatePreset">
              <option value="">—</option>
              <option value="5">θe=5°C (>-8.5°C)</option>
              <option value="-5">θe=-5°C (-8.5…-14.5°C)</option>
              <option value="-10">θe=-10°C (<-14.5°C)</option>
            </select>
          </div>
          <div>
            <label>&nbsp;</label>
            <button class="btn secondary" onclick="applyClimatePreset()" type="button">Apply Preset</button>
          </div>
        </div>
        <div class="actions" style="margin-top:10px">
          <button class="btn" onclick="runAnalyze()" type="button">Calculate</button>
        </div>
      </div>
    </div>

    <div class="grid" style="margin-top:16px">
      <div class="card">
        <h3>Results</h3>
        <div id="results" class="result">Fill layers and click Calculate.</div>
      </div>
      <div class="card">
        <h3>Condensation Zones</h3>
        <div id="zones" class="result">—</div>
      </div>
    </div>

    <div class="charts" style="margin-top:16px">
      <div class="card">
        <h3>Assembly Diagram (Layers + &theta;)</h3>
        <canvas id="chartAssembly"></canvas>
        <div class="footer">Shaded red: condensation within layers (mapped from Σz). Interfaces are vertical lines.</div>
      </div>
      <div class="card">
        <h3>Temperature vs Σd (m)</h3>
        <canvas id="chartTemp"></canvas>
      </div>
      <div class="card">
        <h3>p and p_sat vs z (m²Pa·h/kg)</h3>
        <canvas id="chartVapor"></canvas>
      </div>
    </div>
    <div class="card" style="margin-top:16px">
      <h3>Generated Report</h3>
      <div id="report-html"></div>
    </div>
    <div class="footer">Tip: Use material presets per layer, and adjust thickness sliders for quick what-if analysis.</div>
  </div>

  <script>
    // If static/app.js failed to load, provide minimal inline fallback
    if (!window.__appLoaded) {
      const layersDiv = document.getElementById('layers');
      let materials = [];
      const makeLayerEl = (idx) => {
        const d = document.createElement('div');
        d.className = 'row';
        d.innerHTML = `
          <div>
            <label>Material</label>
            <select data-idx="${idx}" class="matSelect"><option value="">—</option></select>
            <label>Name</label>
            <input type="text" class="name" value="Layer ${idx+1}">
          </div>
          <div>
            <label>Thickness (m)</label>
            <input type="number" step="0.001" class="d" value="0.100">
            <input type="range" min="0.005" max="0.500" step="0.001" value="0.100" class="dSlider">
          </div>
          <div>
            <label>λ (W/mK)</label>
            <input type="number" step="0.001" class="lambda" value="0.040">
          </div>
          <div>
            <label>μ (-)</label>
            <input type="number" step="1" class="mu" value="20">
          </div>
          <div>
            <label>ρ (kg/m³)</label>
            <input type="number" step="1" class="rho" value="800">
          </div>
          <div>
            <label>xr (%)</label>
            <input type="number" step="0.1" class="xr" value="5">
          </div>
          <div>
            <label>xmax (%)</label>
            <input type="number" step="0.1" class="xmax" value="20">
          </div>`;
        // sync slider
        const dInput = d.querySelector('.d');
        const dSlider = d.querySelector('.dSlider');
        dSlider.addEventListener('input', () => { dInput.value = (+dSlider.value).toFixed(3); });
        dInput.addEventListener('input', () => { dSlider.value = dInput.value; });
        // material select
        const sel = d.querySelector('.matSelect');
        sel.addEventListener('change', () => {
          const m = materials.find(mm => mm.name === sel.value);
          if (m) {
            d.querySelector('.lambda').value = m.lambda_;
            d.querySelector('.mu').value = m.mu;
            d.querySelector('.rho').value = m.rho;
            d.querySelector('.xr').value = m.xr_percent;
            d.querySelector('.xmax').value = m.xmax_percent;
            d.querySelector('.name').value = m.name;
          }
        });
        // fill materials if loaded
        const fillSel = () => {
          sel.innerHTML = '<option value="">—</option>' + materials.map(m => `<option>${m.name}</option>`).join('');
        };
        d.fillMaterials = fillSel;
        return d;
      };
      const layers = [];
      window.addLayer = () => {
        const idx = layers.length;
        const el = makeLayerEl(idx);
        layers.push(el);
        layersDiv.appendChild(el);
        if (materials.length) el.fillMaterials();
      };
      window.removeLayer = () => {
        const el = layers.pop();
        if (el) el.remove();
      };
      window.loadMaterials = async () => {
        try {
          const res = await fetch('/materials');
          const js = await res.json();
          if (js.ok) {
            materials = js.materials;
            layers.forEach(el => el.fillMaterials && el.fillMaterials());
          }
        } catch (e) { console.warn(e); }
      };
      window.runAnalyze = async () => {
        const layersPayload = layers.map(el => ({
          name: el.querySelector('.name').value,
          d: parseFloat(el.querySelector('.d').value || '0'),
          lambda_: parseFloat(el.querySelector('.lambda').value || '0'),
          mu: parseFloat(el.querySelector('.mu').value || '0'),
          rho: parseFloat(el.querySelector('.rho').value || '0'),
          xr_percent: parseFloat(el.querySelector('.xr').value || '0'),
          xmax_percent: parseFloat(el.querySelector('.xmax').value || '0'),
        })).filter(L => L.d > 0 && L.lambda_ > 0);
        if (!layersPayload.length) { alert('Add at least one valid layer'); return; }
        const payload = {
          layers: layersPayload,
          Rsi: parseFloat(document.getElementById('Rsi').value || '0.13'),
          Rse: parseFloat(document.getElementById('Rse').value || '0.04'),
          climate: {
            theta_i: parseFloat(document.getElementById('theta_i').value || '20'),
            phi_i: parseFloat(document.getElementById('phi_i').value || '65'),
            theta_e: parseFloat(document.getElementById('theta_e').value || '5'),
            phi_e: parseFloat(document.getElementById('phi_e').value || '90'),
          }
        };
        const res = await fetch('/analyze', {method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(payload)});
        const js = await res.json();
        if (!js.ok) { document.getElementById('results').textContent = 'Error: '+js.error; return; }
        const r = js.result;
        document.getElementById('results').textContent = (
          `U=${r.U.toFixed(4)} W/m²K\n`+
          `ΣR=${r.R_total.toFixed(4)} m²K/W, q=${r.q.toFixed(3)} W/m²\n`+
          `Surface risk: ${r.surface.risk ? 'Yes' : 'No'} (θsi=${r.surface.theta_si.toFixed(2)}°C vs θs=${r.surface.theta_s.toFixed(2)}°C)\n`+
          `Wk_total=${r.Wk_total.toFixed(4)} kg/m² over tk=1440h, Drying capacity=${r.drying_capacity.toFixed(4)} kg/m² → OK=${r.drying_ok ? 'Yes':'No'}`
        );
        const zones = r.zones || [];
        document.getElementById('zones').textContent = zones.length ? zones.map(z => `(${z.start_z.toFixed(3)} → ${z.end_z.toFixed(3)}) maxΔp=${z.max_excess_pa.toFixed(0)} Pa`).join('\n') : '—';
        drawAssembly(r.layers || [], r.thickness_axis, r.theta_profile, r.zones || [], r.vapor_axis);
        drawTemp(r.thickness_axis, r.theta_profile);
        drawVapor(r.vapor_axis, r.p_line, r.p_sat, r.zones || [], r.vapor_axis_final, r.p_final);
      };
      function linMap(v, v0,v1, p0,p1){ return p0 + (v - v0) * (p1 - p0) / (v1 - v0 || 1); }
      function mapZtoX(z, zAxis, xAxis){
        if (!zAxis || !xAxis || zAxis.length !== xAxis.length) return 0;
        if (z <= zAxis[0]) return xAxis[0];
        if (z >= zAxis[zAxis.length-1]) return xAxis[xAxis.length-1];
        for (let i=1;i<zAxis.length;i++){
          if (z <= zAxis[i]){
            const z0=zAxis[i-1], z1=zAxis[i]; const x0=xAxis[i-1], x1=xAxis[i];
            const t=(z - z0)/((z1 - z0)||1); return x0 + t*(x1 - x0);
          }
        }
        return xAxis[xAxis.length-1];
      }
      function drawTemp(x, y){ const c=document.getElementById('chartTemp'); const ctx=c.getContext('2d'); ctx.clearRect(0,0,c.width,c.height); const w=c.width, h=c.height; const pad=40; const xmin=Math.min(...x), xmax=Math.max(...x); const ymin=Math.min(...y), ymax=Math.max(...y); ctx.strokeStyle='#444'; ctx.strokeRect(0,0,w,h); ctx.save(); ctx.translate(pad,pad); const iw=w-2*pad, ih=h-2*pad; ctx.fillStyle='#9ca3af'; ctx.font='12px sans-serif'; ctx.fillText(`${xmin.toFixed(2)} m`,0,ih+16); ctx.fillText(`${xmax.toFixed(2)} m`,iw-60,ih+16); ctx.fillText(`${ymin.toFixed(1)}°C`,-30,ih); ctx.fillText(`${ymax.toFixed(1)}°C`,-30,10); ctx.beginPath(); for(let i=0;i<x.length;i++){ const X=linMap(x[i], xmin,xmax, 0,iw); const Y=linMap(y[i], ymin,ymax, ih,0); if(i===0) ctx.moveTo(X,Y); else ctx.lineTo(X,Y);} ctx.strokeStyle='#60a5fa'; ctx.lineWidth=2; ctx.stroke(); ctx.restore(); }
      function drawVapor(x, p, ps, zones, xf, pf){ const c=document.getElementById('chartVapor'); const ctx=c.getContext('2d'); ctx.clearRect(0,0,c.width,c.height); const w=c.width,h=c.height; const pad=40; const xmin=Math.min(...x), xmax=Math.max(...x); const all=[...p,...ps]; const ymin=Math.min(...all), ymax=Math.max(...all); ctx.strokeStyle='#444'; ctx.strokeRect(0,0,w,h); ctx.save(); ctx.translate(pad,pad); const iw=w-2*pad, ih=h-2*pad; ctx.fillStyle='#9ca3af'; ctx.font='12px sans-serif'; ctx.fillText(`${xmin.toFixed(2)}`,0,ih+16); ctx.fillText(`${xmax.toFixed(2)}`,iw-30,ih+16); ctx.fillText(`${(ymin/100).toFixed(0)} hPa`,-35,ih); ctx.fillText(`${(ymax/100).toFixed(0)} hPa`,-35,10); const plot = (xs, arr, color) => { ctx.beginPath(); for(let i=0;i<xs.length;i++){ const X=linMap(xs[i], xmin,xmax,0,iw); const Y=linMap(arr[i], ymin,ymax, ih,0); if(i===0) ctx.moveTo(X,Y); else ctx.lineTo(X,Y);} ctx.strokeStyle=color; ctx.lineWidth=2; ctx.stroke(); };
        if (zones && zones.length){ ctx.fillStyle='rgba(248,113,113,0.15)'; zones.forEach(z => { const X0=linMap(z.start_z, xmin,xmax,0,iw); const X1=linMap(z.end_z, xmin,xmax,0,iw); ctx.fillRect(Math.min(X0,X1),0, Math.abs(X1-X0), ih); }); }
        plot(x, ps, '#f87171');
        plot(x, p, '#34d399');
        if (xf && pf) plot(xf, pf, '#93c5fd');
        ctx.restore(); }
      function drawAssembly(layers, xAxis, temps, zones, zAxis){
        const c=document.getElementById('chartAssembly'); const ctx=c.getContext('2d'); ctx.clearRect(0,0,c.width,c.height); const w=c.width,h=c.height; const pad=40; const xmin=Math.min(...xAxis), xmax=Math.max(...xAxis); const ymin=Math.min(...temps), ymax=Math.max(...temps); ctx.strokeStyle='#444'; ctx.strokeRect(0,0,w,h); ctx.save(); ctx.translate(pad,pad); const iw=w-2*pad, ih=h-2*pad;
        let x0=xAxis[0]||0; for (let i=1;i<xAxis.length;i++){ const x1=xAxis[i]; const X0=linMap(x0, xmin,xmax,0,iw), X1=linMap(x1, xmin,xmax,0,iw); ctx.fillStyle='rgba(255,255,255,0.05)'; ctx.fillRect(X0,0,X1-X0,ih); ctx.strokeStyle='#1f2937'; ctx.strokeRect(X0,0,X1-X0,ih); const name=layers[i-1]?.name||`L${i}`; ctx.fillStyle='#e5e7eb'; ctx.font='12px sans-serif'; ctx.fillText(`${name} (${(x1-x0).toFixed(3)} m)`, X0+6, 16); x0=x1; }
        // interfaces
        ctx.strokeStyle='#374151'; for (let i=0;i<xAxis.length;i++){ const X=linMap(xAxis[i], xmin,xmax,0,iw); ctx.beginPath(); ctx.moveTo(X,0); ctx.lineTo(X,ih); ctx.stroke(); }
        // zones
        if (zones && zones.length){ ctx.fillStyle='rgba(248,113,113,0.25)'; zones.forEach(z => { const xA=mapZtoX(z.start_z, zAxis, xAxis); const xB=mapZtoX(z.end_z, zAxis, xAxis); const XA=linMap(xA, xmin,xmax,0,iw), XB=linMap(xB, xmin,xmax,0,iw); ctx.fillRect(Math.min(XA,XB),0, Math.abs(XB-XA), ih); }); }
        // temperature
        ctx.beginPath(); for(let i=0;i<xAxis.length;i++){ const X=linMap(xAxis[i], xmin,xmax,0,iw); const Y=linMap(temps[i], ymin,ymax, ih,0); if(i===0) ctx.moveTo(X,Y); else ctx.lineTo(X,Y);} ctx.strokeStyle='#60a5fa'; ctx.lineWidth=2; ctx.stroke(); ctx.restore();
      }
      // init with one layer
      addLayer();
    }
  </script>
</body>
</html>

